# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
orbs:
  cloudsmith: cloudsmith/cloudsmith@1.0.1
jobs:
  checkout:
    docker:
      - image: kernelci/build-gcc-8_x86:latest
    working_directory: ~/build
    steps:
      - checkout
      - restore_cache:
         keys:
           - build-{{ checksum "Makefile" }}
      - run:
          name: 'Prepare build environment...'
          command: |
            if [ -d "~/build/linux-stable" ]; then
              echo 'Build environment was cached.'
            else
              echo 'Build environment was not cached.'
              apt-get update -qq --allow-releaseinfo-change
              apt-get install patch
              apt-get install --reinstall make
              make prepare
            fi
      - save_cache:
          key: build-{{ checksum "Makefile" }}
          paths:
            - build
      - persist_to_workspace:
          root: ~/build
          paths:
            - linux-stable
workflows:
  version: 2
  build-and-deploy:
    jobs:
        - checkout
